{% extends "base.html" %}
{% load humanize %}

{% block title %}Shopping Cart - BidMarket{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen py-6">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Header -->
        <div class="mb-6">
            <h1 class="text-3xl font-bold text-gray-900">Shopping Cart</h1>
            <p class="text-gray-600 mt-1">Review your items before checkout</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Cart Items -->
            <div class="lg:col-span-2">
                <div id="cartItems" class="space-y-4">
                    <!-- Loading state -->
                    <div class="bg-white rounded-lg shadow-sm p-8 text-center">
                        <svg class="animate-spin h-8 w-8 text-orange-500 mx-auto mb-2" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="text-gray-500">Loading cart...</p>
                    </div>
                </div>
            </div>

            <!-- Cart Summary -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-sm p-6 sticky top-4">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">Order Summary</h2>
                    
                    <div class="space-y-3 mb-6">
                        <div class="flex justify-between text-gray-700">
                            <span>Items (<span id="summaryItemCount">0</span>)</span>
                            <span id="summarySubtotal">KSh 0</span>
                        </div>
                        <div class="flex justify-between text-gray-700">
                            <span>Shipping</span>
                            <span class="text-green-600">FREE</span>
                        </div>
                        <div class="border-t pt-3 flex justify-between text-lg font-bold text-gray-900">
                            <span>Total</span>
                            <span id="summaryTotal" class="text-orange-600">KSh 0</span>
                        </div>
                    </div>

                    <a
                        href="{% url 'checkout' %}"
                        id="checkoutBtn"
                        class="block w-full bg-orange-500 text-white font-bold py-4 rounded-lg hover:bg-orange-600 transition text-center disabled:bg-gray-300 disabled:cursor-not-allowed"
                    >
                        Proceed to Checkout
                    </a>

                    <a href="{% url 'browse' %}" class="block text-center text-orange-500 hover:text-orange-600 font-semibold mt-4">
                        Continue Shopping
                    </a>
                </div>
            </div>

        </div>

    </div>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

let currentCart = null;

async function loadCart() {
    try {
        const response = await fetch('/api/cart/', {
            credentials: 'include'
        });

        if (response.ok) {
            currentCart = await response.json();
            renderCart();
        } else {
            showError('Failed to load cart');
        }
    } catch (error) {
        console.error('Error loading cart:', error);
        showError('Connection error');
    }
}

function renderCart() {
    const cartItemsDiv = document.getElementById('cartItems');
    const checkoutBtn = document.getElementById('checkoutBtn');

    if (!currentCart || currentCart.items.length === 0) {
        cartItemsDiv.innerHTML = `
            <div class="bg-white rounded-lg shadow-sm p-12 text-center">
                <svg class="mx-auto h-24 w-24 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
                </svg>
                <h3 class="text-lg font-bold text-gray-900 mb-2">Your cart is empty</h3>
                <p class="text-gray-500 mb-4">Start shopping to add items to your cart</p>
                <a href="{% url 'browse' %}" class="inline-block bg-orange-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-orange-600 transition">
                    Browse Products
                </a>
            </div>
        `;
        checkoutBtn.disabled = true;
        updateSummary();
        return;
    }

    cartItemsDiv.innerHTML = currentCart.items.map(item => `
        <div class="bg-white rounded-lg shadow-sm p-4">
            <div class="flex gap-4">
                <!-- Product Image -->
                <div class="w-24 h-24 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0">
                    ${item.product.main_image ?
                        `<img src="${item.product.main_image}" alt="${item.product.title}" class="w-full h-full object-cover">` :
                        `<div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-gray-200 to-gray-300">
                            <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                        </div>`
                    }
                </div>

                <!-- Product Info -->
                <div class="flex-1 min-w-0">
                    <h3 class="text-lg font-semibold text-gray-900 mb-1">
                        <a href="/auction/${item.product.id}/" class="hover:text-orange-500">${item.product.title}</a>
                    </h3>
                    <div class="text-sm text-gray-600 mb-3">
                        KSh ${Number(item.price).toLocaleString()} each
                    </div>

                    <!-- Quantity Controls -->
                    <div class="flex items-center gap-4">
                        <div class="flex items-center border border-gray-300 rounded-lg">
                            <button
                                onclick="updateQuantity('${item.id}', ${item.quantity - 1})"
                                class="px-3 py-1 hover:bg-gray-100 transition"
                                ${item.quantity <= 1 ? 'disabled class="opacity-50 cursor-not-allowed"' : ''}
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                                </svg>
                            </button>
                            <span class="px-4 py-1 font-semibold">${item.quantity}</span>
                            <button
                                onclick="updateQuantity('${item.id}', ${item.quantity + 1})"
                                class="px-3 py-1 hover:bg-gray-100 transition"
                                ${item.quantity >= item.product.stock_quantity ? 'disabled class="opacity-50 cursor-not-allowed"' : ''}
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                            </button>
                        </div>

                        <button
                            onclick="removeItem('${item.id}')"
                            class="text-red-600 hover:text-red-700 text-sm font-semibold"
                        >
                            Remove
                        </button>
                    </div>

                    ${item.product.stock_quantity && item.quantity >= item.product.stock_quantity ?
                        '<div class="text-xs text-orange-600 mt-2">Maximum quantity reached</div>' : ''}
                </div>

                <!-- Price -->
                <div class="text-right">
                    <div class="text-xl font-bold text-gray-900">
                        KSh ${Number(item.total_price).toLocaleString()}
                    </div>
                </div>
            </div>
        </div>
    `).join('');

    checkoutBtn.disabled = false;
    updateSummary();
}

function updateSummary() {
    const itemCount = currentCart?.total_items || 0;
    const subtotal = currentCart?.subtotal || 0;

    document.getElementById('summaryItemCount').textContent = itemCount;
    document.getElementById('summarySubtotal').textContent = `KSh ${Number(subtotal).toLocaleString()}`;
    document.getElementById('summaryTotal').textContent = `KSh ${Number(subtotal).toLocaleString()}`;
}

async function updateQuantity(itemId, newQuantity) {
    if (newQuantity < 1) return;

    try {
        const response = await fetch(`/api/cart/${itemId}/update_quantity/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'include',
            body: JSON.stringify({ quantity: newQuantity })
        });

        if (response.ok) {
            await loadCart();
        } else {
            const error = await response.json();
            alert(error.error || 'Failed to update quantity');
        }
    } catch (error) {
        console.error('Error updating quantity:', error);
        alert('Failed to update quantity');
    }
}

async function removeItem(itemId) {
    if (!confirm('Remove this item from cart?')) return;

    try {
        const response = await fetch(`/api/cart/${itemId}/remove_item/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'include'
        });

        if (response.ok) {
            await loadCart();
        } else {
            alert('Failed to remove item');
        }
    } catch (error) {
        console.error('Error removing item:', error);
        alert('Failed to remove item');
    }
}

function showError(message) {
    document.getElementById('cartItems').innerHTML = `
        <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
            <p class="text-red-800">${message}</p>
        </div>
    `;
}

// Load cart on page load
loadCart();

function showError(message) {
    document.getElementById('cartItems').innerHTML = `
        <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
            <p class="text-red-800">${message}</p>
        </div>
    `;
}

// Load cart on page load
loadCart();
</script>
{% endblock %}